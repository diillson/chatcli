{{- if .Values.rbac.create -}}
{{- /*
  Auto-detect if ClusterRole is needed:
  1. Explicitly set via rbac.clusterWide: true
  2. Multi-target watcher with targets in different namespaces
*/ -}}
{{- $needsClusterWide := .Values.rbac.clusterWide -}}
{{- if and (not $needsClusterWide) .Values.watcher.enabled .Values.watcher.targets -}}
  {{- $namespaces := dict -}}
  {{- range .Values.watcher.targets -}}
    {{- $ns := .namespace | default "default" -}}
    {{- $_ := set $namespaces $ns true -}}
  {{- end -}}
  {{- if gt (len $namespaces) 1 -}}
    {{- $needsClusterWide = true -}}
  {{- end -}}
{{- end -}}
{{- if $needsClusterWide }}
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "chatcli.fullname" . }}
  labels:
    {{- include "chatcli.labels" . | nindent 4 }}
rules:
  # Core resources for watcher mode
  - apiGroups: [""]
    resources: ["pods", "pods/log", "events", "services", "endpoints", "namespaces"]
    verbs: ["get", "list", "watch"]
  # Runbook CRD (controller creates auto-generated runbooks)
  - apiGroups: [ "platform.chatcli.io" ]
    resources: [ "runbooks" ]
    verbs: [ "get", "list", "watch", "create", "update", "patch" ]
  # Apps resources
  - apiGroups: ["apps"]
    resources: ["deployments", "replicasets", "statefulsets", "daemonsets"]
    verbs: ["get", "list", "watch"]
  # Autoscaling
  - apiGroups: ["autoscaling"]
    resources: ["horizontalpodautoscalers"]
    verbs: ["get", "list", "watch"]
  # Networking
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingresses"]
    verbs: ["get", "list", "watch"]
  # Metrics (for resource usage)
  - apiGroups: ["metrics.k8s.io"]
    resources: ["pods", "nodes"]
    verbs: ["get", "list"]
  {{- with .Values.rbac.additionalRules }}
  {{- toYaml . | nindent 2 }}
  {{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "chatcli.fullname" . }}
  labels:
    {{- include "chatcli.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "chatcli.fullname" . }}
subjects:
  - kind: ServiceAccount
    name: {{ include "chatcli.serviceAccountName" . }}
    namespace: {{ .Release.Namespace }}
{{- else }}
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "chatcli.fullname" . }}
  labels:
    {{- include "chatcli.labels" . | nindent 4 }}
rules:
  # Core resources for watcher mode (namespace-scoped)
  - apiGroups: [""]
    resources: ["pods", "pods/log", "events", "services", "endpoints"]
    verbs: ["get", "list", "watch"]
  # Runbook CRD (controller creates auto-generated runbooks)
  - apiGroups: [ "platform.chatcli.io" ]
    resources: [ "runbooks" ]
    verbs: [ "get", "list", "watch", "create", "update", "patch" ]
  # Apps resources
  - apiGroups: ["apps"]
    resources: ["deployments", "replicasets", "statefulsets", "daemonsets"]
    verbs: ["get", "list", "watch"]
  # Autoscaling
  - apiGroups: ["autoscaling"]
    resources: ["horizontalpodautoscalers"]
    verbs: ["get", "list", "watch"]
  # Networking
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingresses"]
    verbs: ["get", "list", "watch"]
  # Metrics (for resource usage)
  - apiGroups: ["metrics.k8s.io"]
    resources: ["pods"]
    verbs: ["get", "list"]
  {{- with .Values.rbac.additionalRules }}
  {{- toYaml . | nindent 2 }}
  {{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "chatcli.fullname" . }}
  labels:
    {{- include "chatcli.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "chatcli.fullname" . }}
subjects:
  - kind: ServiceAccount
    name: {{ include "chatcli.serviceAccountName" . }}
    namespace: {{ .Release.Namespace }}
{{- end }}
{{- end }}
