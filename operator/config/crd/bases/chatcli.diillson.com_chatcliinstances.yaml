---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: chatcliinstances.chatcli.diillson.com
  annotations:
    controller-gen.kubebuilder.io/version: v0.17.2
spec:
  group: chatcli.diillson.com
  names:
    kind: ChatCLIInstance
    listKind: ChatCLIInstanceList
    plural: chatcliinstances
    singular: chatcliinstance
    shortNames:
      - chatcli
      - cci
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Ready
          type: boolean
          jsonPath: .status.ready
        - name: Replicas
          type: integer
          jsonPath: .status.replicas
        - name: Provider
          type: string
          jsonPath: .spec.provider
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      schema:
        openAPIV3Schema:
          description: ChatCLIInstance is the Schema for the chatcliinstances API.
          type: object
          required:
            - spec
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              description: ChatCLIInstanceSpec defines the desired state of a ChatCLI deployment.
              type: object
              required:
                - provider
              properties:
                replicas:
                  description: Replicas is the number of ChatCLI server pods.
                  type: integer
                  format: int32
                  default: 1
                  minimum: 0
                provider:
                  description: "Provider is the LLM provider (OPENAI, CLAUDEAI, GOOGLEAI, XAI, STACKSPOT, OLLAMA)."
                  type: string
                model:
                  description: Model is the LLM model name.
                  type: string
                image:
                  description: Image defines the container image for ChatCLI.
                  type: object
                  properties:
                    repository:
                      description: Repository is the container image repository.
                      type: string
                      default: "ghcr.io/diillson/chatcli"
                    tag:
                      description: Tag is the container image tag.
                      type: string
                      default: "latest"
                    pullPolicy:
                      description: PullPolicy defines the image pull policy.
                      type: string
                      default: IfNotPresent
                      enum:
                        - Always
                        - IfNotPresent
                        - Never
                server:
                  description: Server configures the gRPC server.
                  type: object
                  properties:
                    port:
                      description: Port is the gRPC server port.
                      type: integer
                      format: int32
                      default: 50051
                    metricsPort:
                      description: MetricsPort is the Prometheus metrics HTTP port (0 = disabled).
                      type: integer
                      format: int32
                      default: 9090
                    tls:
                      description: TLS configures TLS for the gRPC server.
                      type: object
                      properties:
                        enabled:
                          description: Enabled enables TLS.
                          type: boolean
                        secretName:
                          description: SecretName is the name of the Secret containing tls.crt and tls.key.
                          type: string
                    token:
                      description: Token references a Secret containing the auth token.
                      type: object
                      required:
                        - name
                        - key
                      properties:
                        name:
                          description: Name is the Secret name.
                          type: string
                        key:
                          description: Key is the key within the Secret.
                          type: string
                watcher:
                  description: Watcher configures the Kubernetes resource watcher.
                  type: object
                  properties:
                    enabled:
                      description: Enabled activates the watcher.
                      type: boolean
                    deployment:
                      description: "Deployment is the target deployment to watch (legacy single-target mode)."
                      type: string
                    namespace:
                      description: "Namespace is the namespace of the target deployment (legacy single-target mode)."
                      type: string
                    targets:
                      description: "Targets defines multiple deployments to watch simultaneously. When set, deployment and namespace fields are ignored."
                      type: array
                      items:
                        type: object
                        required:
                          - deployment
                          - namespace
                        properties:
                          deployment:
                            description: Deployment is the deployment name to monitor.
                            type: string
                          namespace:
                            description: Namespace is the namespace of the deployment.
                            type: string
                          metricsPort:
                            description: "MetricsPort is the port where Prometheus metrics are exposed (0 = disabled)."
                            type: integer
                            format: int32
                          metricsPath:
                            description: "MetricsPath is the HTTP path for Prometheus metrics (default: /metrics)."
                            type: string
                          metricsFilter:
                            description: MetricsFilter is a list of glob patterns to filter Prometheus metrics.
                            type: array
                            items:
                              type: string
                    interval:
                      description: "Interval is the collection interval (e.g., 30s, 1m)."
                      type: string
                      default: "30s"
                    window:
                      description: "Window is the observation window (e.g., 2h, 30m)."
                      type: string
                      default: "2h"
                    maxLogLines:
                      description: MaxLogLines is the maximum number of log lines to collect per pod.
                      type: integer
                      format: int32
                      default: 100
                    maxContextChars:
                      description: MaxContextChars is the maximum characters for LLM context budget.
                      type: integer
                      format: int32
                      default: 32000
                resources:
                  description: Resources defines resource requests/limits for the ChatCLI container.
                  type: object
                  properties:
                    claims:
                      items:
                        properties:
                          name:
                            type: string
                          request:
                            type: string
                        required:
                          - name
                        type: object
                      type: array
                      x-kubernetes-list-map-keys:
                        - name
                      x-kubernetes-list-type: map
                    limits:
                      additionalProperties:
                        anyOf:
                          - type: integer
                          - type: string
                        pattern: "^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$"
                        x-kubernetes-int-or-string: true
                      type: object
                    requests:
                      additionalProperties:
                        anyOf:
                          - type: integer
                          - type: string
                        pattern: "^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$"
                        x-kubernetes-int-or-string: true
                      type: object
                persistence:
                  description: Persistence configures persistent storage for sessions.
                  type: object
                  properties:
                    enabled:
                      description: Enabled activates persistent storage.
                      type: boolean
                    size:
                      description: "Size is the PVC size (e.g., 1Gi)."
                      type: string
                      default: "1Gi"
                    storageClassName:
                      description: StorageClassName is the storage class to use.
                      type: string
                securityContext:
                  description: SecurityContext for the pod.
                  type: object
                  properties:
                    fsGroup:
                      type: integer
                      format: int64
                    fsGroupChangePolicy:
                      type: string
                    runAsGroup:
                      type: integer
                      format: int64
                    runAsNonRoot:
                      type: boolean
                    runAsUser:
                      type: integer
                      format: int64
                    seccompProfile:
                      type: object
                      properties:
                        localhostProfile:
                          type: string
                        type:
                          type: string
                      required:
                        - type
                    supplementalGroups:
                      items:
                        type: integer
                        format: int64
                      type: array
                    sysctls:
                      items:
                        properties:
                          name:
                            type: string
                          value:
                            type: string
                        required:
                          - name
                          - value
                        type: object
                      type: array
                apiKeys:
                  description: APIKeys references a Secret containing provider API keys.
                  type: object
                  required:
                    - name
                  properties:
                    name:
                      description: Name is the Secret name.
                      type: string
            status:
              description: ChatCLIInstanceStatus defines the observed state of ChatCLIInstance.
              type: object
              properties:
                ready:
                  description: Ready indicates whether all replicas are available.
                  type: boolean
                replicas:
                  description: Replicas is the total number of desired replicas.
                  type: integer
                  format: int32
                readyReplicas:
                  description: ReadyReplicas is the number of ready replicas.
                  type: integer
                  format: int32
                conditions:
                  description: Conditions represent the latest available observations of the instance state.
                  type: array
                  items:
                    type: object
                    required:
                      - lastTransitionTime
                      - message
                      - reason
                      - status
                      - type
                    properties:
                      lastTransitionTime:
                        type: string
                        format: date-time
                      message:
                        type: string
                        maxLength: 32768
                      observedGeneration:
                        type: integer
                        format: int64
                        minimum: 0
                      reason:
                        type: string
                        maxLength: 1024
                        minLength: 1
                        pattern: "^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$"
                      status:
                        type: string
                        enum:
                          - "True"
                          - "False"
                          - Unknown
                      type:
                        type: string
                        maxLength: 316
                        pattern: "^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$"
                  x-kubernetes-list-map-keys:
                    - type
                  x-kubernetes-list-type: map
                observedGeneration:
                  description: ObservedGeneration tracks which generation was last reconciled.
                  type: integer
                  format: int64
