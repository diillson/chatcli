apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: postmortems.platform.chatcli.io
  annotations:
    controller-gen.kubebuilder.io/version: v0.17.2
spec:
  group: platform.chatcli.io
  names:
    kind: PostMortem
    listKind: PostMortemList
    plural: postmortems
    singular: postmortem
    shortNames:
      - pm
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Issue
          type: string
          jsonPath: .spec.issueRef.name
        - name: Severity
          type: string
          jsonPath: .spec.severity
        - name: State
          type: string
          jsonPath: .status.state
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      schema:
        openAPIV3Schema:
          description: PostMortem captures the full incident lifecycle after resolution.
          type: object
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              description: PostMortemSpec defines the immutable input fields.
              type: object
              required:
                - issueRef
                - resource
                - severity
              properties:
                issueRef:
                  description: Reference to the parent Issue.
                  type: object
                  required:
                    - name
                  properties:
                    name:
                      type: string
                resource:
                  description: Kubernetes resource that was affected.
                  type: object
                  required:
                    - kind
                    - name
                    - namespace
                  properties:
                    kind:
                      type: string
                    name:
                      type: string
                    namespace:
                      type: string
                severity:
                  description: Severity of the original issue.
                  type: string
                  enum:
                    - critical
                    - high
                    - medium
                    - low
            status:
              description: PostMortemStatus defines the observed state.
              type: object
              properties:
                state:
                  description: Review lifecycle state.
                  type: string
                  enum:
                    - Open
                    - InReview
                    - Closed
                summary:
                  description: AI-generated incident summary.
                  type: string
                rootCause:
                  description: AI-determined root cause.
                  type: string
                impact:
                  description: What was affected by the incident.
                  type: string
                timeline:
                  description: Chronological list of incident events.
                  type: array
                  items:
                    type: object
                    required:
                      - timestamp
                      - type
                      - detail
                    properties:
                      timestamp:
                        type: string
                        format: date-time
                      type:
                        type: string
                      detail:
                        type: string
                actionsExecuted:
                  description: All remediation actions and their results.
                  type: array
                  items:
                    type: object
                    required:
                      - action
                      - result
                      - detail
                      - timestamp
                    properties:
                      action:
                        type: string
                      params:
                        type: object
                        additionalProperties:
                          type: string
                      result:
                        type: string
                      detail:
                        type: string
                      timestamp:
                        type: string
                        format: date-time
                lessonsLearned:
                  description: AI-generated lessons from the incident.
                  type: array
                  items:
                    type: string
                preventionActions:
                  description: AI-generated steps to prevent recurrence.
                  type: array
                  items:
                    type: string
                duration:
                  description: Total incident duration.
                  type: string
                generatedAt:
                  description: When this PostMortem was auto-generated.
                  type: string
                  format: date-time
                reviewedAt:
                  description: When the PostMortem was reviewed.
                  type: string
                  format: date-time
